criterion="./data/criterion/P2/13620,./data/criterion/P2/13590,./data/criterion/P2/13650,5#./data/criterion/P1/23040,./data/criterion/P1/23010,./data/criterion/P1/23070,2#./data/criterion/P5/12330,./data/criterion/P5/12300,./data/criterion/P5/12360,2#./data/criterion/P7/16170,./data/criterion/P7/16140,./data/criterion/P7/16200,5#./data/criterion/P10/19410,./data/criterion/P10/19380,./data/criterion/P10/19440,5#./data/criterion/P5/27090,./data/criterion/P5/27060,./data/criterion/P5/27120,1#./data/criterion/P7/660,./data/criterion/P7/630,./data/criterion/P7/690,0#./data/criterion/P8/18540,./data/criterion/P8/18510,./data/criterion/P8/18570,1#./data/criterion/P8/10800,./data/criterion/P8/10770,./data/criterion/P8/10830,3#./data/criterion/P1/22140,./data/criterion/P1/22110,./data/criterion/P1/22170,2#./data/criterion/P3/6420,./data/criterion/P3/6390,./data/criterion/P3/6450,2#./data/criterion/P8/23430,./data/criterion/P8/23400,./data/criterion/P8/23460,2#./data/criterion/P10/6540,./data/criterion/P10/6510,./data/criterion/P10/6570,5#./data/criterion/P10/13170,./data/criterion/P10/13140,./data/criterion/P10/13200,5#./data/criterion/P5/13560,./data/criterion/P5/13530,./data/criterion/P5/13590,3#./data/criterion/P9/15870,./data/criterion/P9/15840,./data/criterion/P9/15900,0#./data/criterion/P5/19080,./data/criterion/P5/19050,./data/criterion/P5/19110,2#./data/criterion/P7/9060,./data/criterion/P7/9030,./data/criterion/P7/9090,3#./data/criterion/P9/17340,./data/criterion/P9/17310,./data/criterion/P9/17370,2#./data/criterion/P10/21270,./data/criterion/P10/21240,./data/criterion/P10/21300,5#";
block1="./data/outputs_part1/P7/14280,./data/outputs_part1/P7/14250,./data/outputs_part1/P7/14310,3#./data/outputs_part1/P3/9000,./data/outputs_part1/P3/8970,./data/outputs_part1/P3/9030,2#./data/outputs_part1/P9/6120,./data/outputs_part1/P9/6090,./data/outputs_part1/P9/6150,3#./data/outputs_part1/P7/990,./data/outputs_part1/P7/960,./data/outputs_part1/P7/1020,0#./data/outputs_part1/P10/11190,./data/outputs_part1/P10/11160,./data/outputs_part1/P10/11220,2#./data/outputs_part1/P7/14070,./data/outputs_part1/P7/14040,./data/outputs_part1/P7/14100,3#./data/outputs_part1/P3/1650,./data/outputs_part1/P3/1620,./data/outputs_part1/P3/1680,2#./data/outputs_part2/P8/3120,./data/outputs_part2/P8/3090,./data/outputs_part2/P8/3150,0#./data/outputs_part1/P2/21390,./data/outputs_part1/P2/21360,./data/outputs_part1/P2/21420,5#./data/outputs_part2/P10/14250,./data/outputs_part2/P10/14220,./data/outputs_part2/P10/14280,0#./data/outputs_part2/P4/6750,./data/outputs_part2/P4/6720,./data/outputs_part2/P4/6780,2#./data/outputs_part2/P1/10230,./data/outputs_part2/P1/10200,./data/outputs_part2/P1/10260,2#./data/outputs_part1/P2/21090,./data/outputs_part1/P2/21060,./data/outputs_part1/P2/21120,5#./data/outputs_part1/P1/11370,./data/outputs_part1/P1/11340,./data/outputs_part1/P1/11400,3#./data/outputs_part1/P5/22440,./data/outputs_part1/P5/22410,./data/outputs_part1/P5/22470,2#./data/outputs_part1/P5/25440,./data/outputs_part1/P5/25410,./data/outputs_part1/P5/25470,0#./data/outputs_part1/P8/19800,./data/outputs_part1/P8/19770,./data/outputs_part1/P8/19830,2#./data/outputs_part1/P6/17010,./data/outputs_part1/P6/16980,./data/outputs_part1/P6/17040,3#./data/outputs_part1/P5/10020,./data/outputs_part1/P5/9990,./data/outputs_part1/P5/10050,0#./data/outputs_part1/P1/6060,./data/outputs_part1/P1/6030,./data/outputs_part1/P1/6090,3#./data/outputs_part1/P9/1230,./data/outputs_part1/P9/1200,./data/outputs_part1/P9/1260,2#./data/outputs_part1/P6/22890,./data/outputs_part1/P6/22860,./data/outputs_part1/P6/22920,5#./data/outputs_part1/P8/27600,./data/outputs_part1/P8/27570,./data/outputs_part1/P8/27630,0#./data/outputs_part1/P7/14670,./data/outputs_part1/P7/14640,./data/outputs_part1/P7/14700,2#./data/outputs_part1/P5/20310,./data/outputs_part1/P5/20280,./data/outputs_part1/P5/20340,1#./data/outputs_part2/P1/16200,./data/outputs_part2/P1/16170,./data/outputs_part2/P1/16230,2#./data/outputs_part1/P8/27780,./data/outputs_part1/P8/27750,./data/outputs_part1/P8/27810,5#./data/outputs_part1/P4/11910,./data/outputs_part1/P4/11880,./data/outputs_part1/P4/11940,1#./data/outputs_part1/P7/23280,./data/outputs_part1/P7/23250,./data/outputs_part1/P7/23310,5#./data/outputs_part1/P9/23790,./data/outputs_part1/P9/23760,./data/outputs_part1/P9/23820,2"
block2="./data/outputs_part1/P10/330,./data/outputs_part1/P10/300,./data/outputs_part1/P10/360,0#./data/outputs_part2/P7/21330,./data/outputs_part2/P7/21300,./data/outputs_part2/P7/21360,2#./data/outputs_part2/P1/3540,./data/outputs_part2/P1/3510,./data/outputs_part2/P1/3570,0#./data/outputs_part1/P1/9720,./data/outputs_part1/P1/9690,./data/outputs_part1/P1/9750,1#./data/outputs_part2/P6/11340,./data/outputs_part2/P6/11310,./data/outputs_part2/P6/11370,0#./data/outputs_part1/P6/20190,./data/outputs_part1/P6/20160,./data/outputs_part1/P6/20220,2#./data/outputs_part1/P3/12090,./data/outputs_part1/P3/12060,./data/outputs_part1/P3/12120,5#./data/outputs_part1/P10/20460,./data/outputs_part1/P10/20430,./data/outputs_part1/P10/20490,5#./data/outputs_part1/P5/27150,./data/outputs_part1/P5/27120,./data/outputs_part1/P5/27180,0#./data/outputs_part1/P2/27450,./data/outputs_part1/P2/27420,./data/outputs_part1/P2/27480,5#./data/outputs_part2/P5/20880,./data/outputs_part2/P5/20850,./data/outputs_part2/P5/20910,0#./data/outputs_part2/P4/3750,./data/outputs_part2/P4/3720,./data/outputs_part2/P4/3780,3#./data/outputs_part1/P2/16560,./data/outputs_part1/P2/16530,./data/outputs_part1/P2/16590,2#./data/outputs_part2/P7/17640,./data/outputs_part2/P7/17610,./data/outputs_part2/P7/17670,5#./data/outputs_part1/P5/13080,./data/outputs_part1/P5/13050,./data/outputs_part1/P5/13110,3#./data/outputs_part2/P7/9570,./data/outputs_part2/P7/9540,./data/outputs_part2/P7/9600,3#./data/outputs_part1/P3/20970,./data/outputs_part1/P3/20940,./data/outputs_part1/P3/21000,2#./data/outputs_part1/P9/360,./data/outputs_part1/P9/330,./data/outputs_part1/P9/390,0#./data/outputs_part1/P1/4440,./data/outputs_part1/P1/4410,./data/outputs_part1/P1/4470,2#./data/outputs_part1/P5/14430,./data/outputs_part1/P5/14400,./data/outputs_part1/P5/14460,3#./data/outputs_part1/P10/600,./data/outputs_part1/P10/570,./data/outputs_part1/P10/630,0#./data/outputs_part1/P1/13230,./data/outputs_part1/P1/13200,./data/outputs_part1/P1/13260,2#./data/outputs_part2/P3/10470,./data/outputs_part2/P3/10440,./data/outputs_part2/P3/10500,3#./data/outputs_part1/P4/12480,./data/outputs_part1/P4/12450,./data/outputs_part1/P4/12510,2#./data/outputs_part1/P5/12930,./data/outputs_part1/P5/12900,./data/outputs_part1/P5/12960,3#./data/outputs_part1/P8/25260,./data/outputs_part1/P8/25230,./data/outputs_part1/P8/25290,2#./data/outputs_part2/P3/12780,./data/outputs_part2/P3/12750,./data/outputs_part2/P3/12810,5#./data/outputs_part2/P10/20280,./data/outputs_part2/P10/20250,./data/outputs_part2/P10/20310,5#./data/outputs_part1/P8/13770,./data/outputs_part1/P8/13740,./data/outputs_part1/P8/13800,5#./data/outputs_part1/P9/13800,./data/outputs_part1/P9/13770,./data/outputs_part1/P9/13830,3#"


criterionSplit=[];

criterionSounds=[];
criterionSounds_pre=[];
criterionSounds_pre=[];
criterionSounds_post=[];
criterionImages=[];
criterionImages_pre=[];
criterionImages_post=[];
currentImage=1;
epoch=1;
change=true;
font=null;
userStage="";

practiceStage=0;

totalClicks=0;
results="";

playSound=true; //should the sound play
dropout=true; //should we keep looping through items until they're gotten correct (true) or go through each only once (false)
pid=0;
startTime=Date.now();
block='0';
demo='';
rts=[];
rtcrit=true; //does the rt distribution look reasonable?
function median(numbers) {
    const sorted = Array.from(numbers).sort((a, b) => a - b);
    const middle = Math.floor(sorted.length / 2);

    if (sorted.length % 2 === 0) {
        return (sorted[middle - 1] + sorted[middle]) / 2;
    }

    return sorted[middle];
}

function preload() {
  demo=loadImage("./data/demo.png");
  urlParams = new URLSearchParams(window.location.search);
  block = urlParams.get('block');
  pid = urlParams.get('pid');
  soundBlock=urlParams.get('sound');
  if (soundBlock==block || block.indexOf("0") > -1) { //play sounds if we are in the sound block
    playSound=true;
  }
  else {
    playSound=false;
  }
  //font=loadFont("../data/font.vlw");
  //load the correct stimuli. If it's 0 or not specified, load the criterion test
  if (block=='1') {
    criterion=block1;
    dropout=false;
    console.log("Loading block1");
  }
  if (block=='2') {
    criterion=block2;
    dropout=false;
    console.log("Loading block2");
  }
  criterionSplit=criterion.split("#");

criterionSplit.forEach((val) => {
    if (val.length > 1) {
      try {
      console.log(val);
      splitup=val.split(",");
      try{
      img1=loadImage(splitup[0]+".png");
      sound = loadSound(splitup[0]+".wav");
      criterionSounds.push(sound);
      criterionImages.push(img1);
      } catch (exceptionVar) {
        console.log("Error on image: "+splitup[0]+exceptionVar);
    }
     try {
      img2=loadImage(splitup[1]+".png");
      sound = loadSound(splitup[1]+".wav");
      criterionSounds_pre.push(sound);
      criterionImages_pre.push(img2);
      }
      catch (exceptionVar) {
        console.log("Error on image: "+splitup[1]+exceptionVar);
      }
      try {
      img3=loadImage(splitup[2]+".png");
      sound = loadSound(splitup[2]+".wav");
      criterionSounds_post.push(sound);
      criterionImages_post.push(img3);
      }
      catch (exceptionVar) {
        console.log("Error on image: "+splitup[2]);
      }
      }
      catch (exceptionvar) {
        
      }
      
}


});
console.log("Size of pre images is "+criterionImages_pre.length);
console.log("Size of post images is "+criterionImages_post.length);
}

function setup() {
  createCanvas(1200, 600);
  textFont("Helvetica");
  textSize(20);
      /*
      img=loadImage((parseInt(splitup[0])-30)+".png");
      criterionImages_pre.push(img);
*/
      
      
    }
    
function dropoutCorrect(stage) {
  console.log("User stage:"+stage+", correct="+criterionSplit[currentImage].split(",")[3]+",dropout="+dropout);
  correct=criterionSplit[currentImage].split(",")[3];
  if (correct.indexOf(stage) > -1 || !dropout) { //if it was correct OR this is a non-dropout block, remove this item from all the arrays
    criterionSounds.splice(currentImage,1);
    criterionSounds_pre.splice(currentImage,1);
    criterionSounds_post.splice(currentImage,1);
    criterionImages.splice(currentImage,1);
    criterionImages_pre.splice(currentImage,1);
    criterionImages_post.splice(currentImage,1);
    criterionSplit.splice(currentImage,1);
  }
  
}
    
function keyPressed() {
	  if (practiceStage == -2) {
    practiceStage++;
  }
  else if (practiceStage == -1) {
    practiceStage=1;
  }
  
  if (practiceStage == 1) {
  if (keyCode == RIGHT_ARROW) {
    epoch++;
    totalClicks++;
  }
  if (keyCode == LEFT_ARROW) {
    epoch--;
    totalClicks++;
  }
  if (epoch < 0) {
    epoch=0;
    totalClicks--;
  }
  if (epoch > 2) {
    epoch=2;
    totalClicks--;
  }
  change=true;
  if (epoch == 1) { //we are viewing the epoch
    if (key == '0' || key == '1' || key == '2' || key == '3' || key == 'r' || key == 'R' || key == 'w' || key == 'W' || key == '5') {
      if (key == 'r' || key == 'R') {
          userStage='5';
      }
      if (key == 'w' || key == 'W') {
          userStage='0';
      }
      else {
      userStage=key;
      }
      userStage=userStage.replace("r","5").replace("R","5");
      practiceStage=2;
      if (playSound) {
      criterionSounds[currentImage].play();
      }
      timeSpent=round((Date.now()-startTime)/1000,2);
      correct=criterionSplit[currentImage].split(",")[3];
      isCorrect=calculateCorrect(userStage, correct);
	    //@sam this runs once per trial and updates the results for each trial. UserStage is the stage the person said, correct is the correct stange, timeSpent is the number of seconds spent on the trial and totalClicks is the number of backwards or forwards command shtye gave.
      results=results+","+userStage+":"+correct+":"+timeSpent+":"+totalClicks;
	  rts.push(timeSpent); //log the rt for this trial
      sendDataToSheet(userStage, correct, timeSpent, totalClicks, pid, block, playSound, isCorrect);
      totalClicks=0;
      
    }  
  }
  }

  else if (practiceStage == 2) {
    
    if (key == ' ') {
      dropoutCorrect(userStage);
      if (criterionSounds.length > 0) {
        currentImage=Math.floor(Math.random() * criterionSounds.length);
        practiceStage = 1;
        epoch=1;
        startTime=Date.now();
      }
      else {
        practiceStage=3;
        console.log("No more items!");
      }
    
    }
  }
}

function calculateCorrect(a, b) {
  if (a === b) {
      return 1;
  } else {
      return 0;
  }
}

function sendDataToSheet(userStage, correct, timeSpent, totalClicks, pid, block, playSound, isCorrect){
  // code that puts everything in a google doc
  let res_key = ["userStage", "correctStage", "timeSpent", "totalClicks", "UserID", "block", "sound", "isCorrect"];
  let res_val = [userStage, correct, timeSpent, int(totalClicks), pid, block, int(playSound), isCorrect];
  var script_result = {};

  res_key.forEach(function (k, i) {
      script_result[k] = res_val[i];
  })

  console.log(JSON.stringify(script_result));

  const url = "https://script.google.com/macros/s/AKfycbxRFheUC48A_7MwukU3h8lQJs8AVM4ydHyOfsd1-AwASNZ1IPa2GRC5Fi10wu5NpSkh/exec";

  fetch(url,{
    method: 'POST', // *GET, POST, PUT, DELETE, etc.
    mode: 'no-cors', // no-cors, *cors, same-origin
    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow', // manual, *follow, error
    body: JSON.stringify(script_result)})
  }

function mouseClicked() {
 if (practiceStage == 0) {
    if (block.indexOf('0') == -1) { //move from the intro to the task if we are in the regular block, but display an additional training screen if we are in the first block.
    practiceStage=1;
    startTime=Date.now();
    }
    else {
      practiceStage = -2;
    }
  }
  
}
function draw() {
  stroke(255);
  fill(255);

  let x_margin = 40; 
  
    if (practiceStage == -2) {
      background(0);
       image(demo,x_margin,0,1100,500,0,0,criterionImages_pre[0].width,1420);
       text("This is how sleep will be displayed. In this practice, you will also hear the EEG transformed into a sound. \nMake sure your volume is turned up. \nPress any key to continue.",x_margin, 520);
    }
   else if (practiceStage == -1) {
     background(0);
       text("First we will have you practice scoring 20 epochs of sleep. \nEach epoch comes from a different subject.  You will see each epoch until you get it correct. \nYou should hear sounds associated with each epoch \nPress any key to continue.",x_margin, 520);
    }
  if (practiceStage == 0) {
    background(0);

    if (block == 0) {
    text("Welcome to the sleep staging experiment!\nClick anywhere to continue.",x_margin, 50);
    }
    else {
      instructions="Now we will have you stage some more sleep. There are 30 epochs in this block, and each comes from a different subject. \nThis time you will see each epoch only once, so try to get it correct on the first try. \n#SOUND \nClick anywhere to continue.";
      if (playSound) {
        instructions=instructions.replace("#SOUND", "In this block, we will play also play sounds that represent the EEG signal in O1-A2 (the same as during the practice)");
      }
      else {
        instructions=instructions.replace("#SOUND", "In this block, you will NOT hear sounds that go with the EEG.");
      }
      text(instructions,x_margin, 50);
      
  }
  }
	
  
  else if (practiceStage == 1) {

  imageMode(CENTER);
  if (epoch == 0) { ///showing the 30 seconds before the stage 
  background(0);
  if (criterionImages_pre[currentImage] != undefined && criterionSounds_pre[currentImage] != undefined) {

  image(criterionImages_pre[currentImage],600,240,1100,500,0,0,criterionImages_pre[currentImage].width,1420);
  if (change && playSound) {
    criterionSounds_pre[currentImage].play();
    change=false;
  }
  }
  text("This is one epoch before the epoch to stage. \nUse the right arrow to go forward in time.",x_margin, 520);
  }
  if (epoch == 1) { ///showing the stage 
  background(50);
  if (criterionImages[currentImage] != undefined && criterionSounds[currentImage] != undefined) {
  image(criterionImages[currentImage],600,240,1100,500,0,0,criterionImages[currentImage].width,1420);
  if (change && playSound) {
   criterionSounds[currentImage].play();
    change=false;
  }
  }
   text("This is the epoch to stage. \nUse arrow keys to move backwards or forwards in time. \nUse w, 1, 2, 3, and R keys to stage the epoch.",x_margin, 520);
  //  console.log(criterionImages_post[currentImage])
  }
  if (epoch == 2) { ///showing the 30 seconds before the stage 
  background(0);
  if (criterionImages_post[currentImage] != undefined && criterionSounds_post[currentImage] != undefined) {
  image(criterionImages_post[currentImage],600,240,1100,500,0,0,criterionImages_post[currentImage].width,1420);
  if (change && playSound) {
    criterionSounds_post[currentImage].play();
    change=false;
  }
  }
   text("This is one epoch after the epoch to stage.\nUse the left arrow to go back in time.",x_margin, 520);
  }
  }
  else if (practiceStage == 2) { //getting feedback on stage
  background(0);
  image(criterionImages[currentImage],600,240,1100,500,0,0,criterionImages[currentImage].width,1420);
   
   correct=criterionSplit[currentImage].split(",")[3];
   text("This epoch is stage "+(correct+"").replace("5","REM").replace("0","wake")+".",x_margin, 520);
  
   if (correct.indexOf(userStage) > -1) {
     fill(0,200,0);
     stroke(0,200,0);
   }
   else {
     fill(200,0,0);
     stroke(200,0,0);
   }
   text("You said: Stage "+userStage.replace("5","REM").replace("0","wake")+"\nPress space to continue.",x_margin, 550);
   
  }
  else if (practiceStage == 3) {
	  //compute whether valid responses based on rt
	 if (median(rts) < 2) {
		 rtcrit=false;
	 }
    window.location.replace("https://mit.co1.qualtrics.com/jfe/form/SV_0pwKV9gTyvvYRT0?data="+results+"&pid="+pid+"&sound="+soundBlock+"&block="+block+"&rts="+median(rts)+"&rtcrit="+rtcrit);
    frameRate(0.001);
  }
    
  
  
}
